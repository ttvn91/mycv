---
import BaseHead from '../components/BaseHead.astro';
import HeroParticles from '../components/HeroParticles.astro';
import Footer from '../components/Footer.astro';
import Analytics from '@vercel/analytics/astro';
import { Image } from 'astro:assets';
import profileImage from '../assets/profile.jpg';
import { getEntry } from 'astro:content';

interface Props {
	lang: 'vi' | 'en';
}

const { lang } = Astro.props;

// Fetch data from content collections
const resumeData = await getEntry('resume', lang);
const resumeConfig = await getEntry('config', 'config');

if (!resumeData || !resumeConfig) {
	throw new Error(`Could not find resume data for lang: ${lang}`);
}

const content = resumeData.data;
const config = resumeConfig.data;
const theme = config.theme || { primaryColor: '#ea580c', backgroundColor: '#f8fafc', textColor: '#0f172a', imageSize: 512, enableParticles: true, headerAlign: 'left' };
const imgSize = theme.imageSize || 512;

const displayName = content.fullName || (lang === 'vi' ? "Nguyễn Hoàng Hải Nam" : "Nguyen Hoang Hai Nam");
const pdfBaseName = config.pdfFileName || "CV-Nguyen_Hoang_Hai_Nam";
const pdfLangExtension = lang === 'vi' ? 'vn' : 'en';
const pdfFileName = `${pdfBaseName}.${pdfLangExtension}.pdf`;

const currentYear = new Date().getFullYear();
const expYears = currentYear - config.startYear;
---

<!doctype html>
<html lang={lang}>
	<head>
		<BaseHead title={`${displayName} - Marketing Technologist`} description="Portfolio & CV" />
        <style>
            @media print {
                body {
                    background-color: white !important;
                    --bg: white !important;
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
                .print\:break-after-page {
                    break-after: page;
                }
                /* Ẩn shadow khi in để văn bản sắc nét hơn */
                * {
                    box-shadow: none !important;
                    text-shadow: none !important;
                }
            }
        </style>
	</head>
	<body 
        class="text-lg font-sans antialiased selection:bg-orange-200 selection:text-orange-900 relative transition-colors duration-300"
        style={`--primary: ${theme.primaryColor}; --bg: ${theme.backgroundColor}; --text: ${theme.textColor}; background-color: var(--bg); color: var(--text);`}
    >
        
        {theme.enableParticles && <HeroParticles />}

        <!-- Floating Language Switcher -->
        <div class="fixed top-4 right-4 z-50 no-print lang-switch">
            <div class="flex items-center bg-white/80 backdrop-blur-md border border-white/50 rounded-full p-1.5 shadow-lg ring-1 ring-slate-900/5 transition-all duration-300 hover:shadow-xl hover:bg-white/90">
                <a 
                    href="/en"
                    data-astro-history="replace"
                    class={`lang-btn px-4 py-1.5 rounded-full text-sm font-bold transition-all duration-300 ${lang === 'en' ? 'text-white shadow-md' : 'text-slate-500 hover:opacity-80'}`}
                    style={lang === 'en' ? `background-color: var(--primary);` : `&:hover { color: var(--primary); }`}
                >
                    EN
                </a>
                <a 
                    href="/vi"
                    data-astro-history="replace"
                    class={`lang-btn px-4 py-1.5 rounded-full text-sm font-bold transition-all duration-300 ${lang === 'vi' ? 'text-white shadow-md' : 'text-slate-500 hover:opacity-80'}`}
                    style={lang === 'vi' ? `background-color: var(--primary);` : `&:hover { color: var(--primary); }`}
                >
                    VN
                </a>
            </div>
        </div>

        <!-- Back to Top Button -->
        <button
            id="back-to-top"
            aria-label="Back to Top"
            class="fixed bottom-6 right-6 z-40 p-3 rounded-full bg-slate-900/80 text-white shadow-lg backdrop-blur-sm transition-all duration-300 opacity-0 invisible translate-y-4 no-print group border border-white/10 hover:opacity-100"
            style="&:hover { background-color: var(--primary); }"
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 group-hover:-translate-y-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
            </svg>
        </button>

        <main class="max-w-4xl mx-auto px-6 py-16 md:py-24 relative z-10">
            
            <div class="keep-together break-after-this">
                <!-- Header Section -->
                <header class="mb-16 pt-8">
                    <div class="relative flex flex-col md:flex-row items-center md:items-start gap-8 md:gap-10 text-center md:text-left">
                        <div class="relative group shrink-0">
                            <div class="absolute -inset-2 bg-gradient-to-tr from-slate-200 to-slate-100 rounded-full blur-xl opacity-60 group-hover:opacity-90 transition duration-1000"></div>
                            <Image 
                                src={profileImage} 
                                alt={displayName} 
                                width={imgSize}
                                height={imgSize}
                                densities={[1.5, 2]}
                                loading="eager"
                                class="relative w-40 h-40 md:w-48 md:h-48 rounded-full object-cover shadow-xl border-4 border-white"
                            />
                        </div>
                        
                        <div class="flex-1 space-y-3 pt-2">
                            <h1 class="text-3xl font-extrabold tracking-tight leading-tight" style="color: var(--text);">
                                {displayName}
                            </h1>
                            <p class="text-lg leading-relaxed max-w-3xl text-slate-600">
                                <span class="font-bold" style="color: var(--primary);">{content.hero.role}</span>
                                {content.hero.description.replace("{exp}", expYears.toString())}
                            </p>
                        </div>
                    </div>
                </header>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-6 mb-16 stats-grid scroll-animate">
                    <div class="p-6 rounded-xl bg-white border border-slate-200 shadow-sm">
                        <div class="text-5xl font-bold mb-2" style="color: var(--primary);">{expYears}+</div>
                        <div class="text-sm font-semibold text-slate-500 uppercase tracking-wider">{content.stats.exp}</div>
                    </div>
                    <div class="p-6 rounded-xl bg-white border border-slate-200 shadow-sm">
                        <div class="text-5xl font-bold mb-2" style="color: var(--primary);">95%</div>
                        <div class="text-sm font-semibold text-slate-500 uppercase tracking-wider">{content.stats.automation}</div>
                    </div>
                    <div class="p-6 rounded-xl bg-white border border-slate-200 shadow-sm col-span-2 md:col-span-1">
                        <div class="text-5xl font-bold mb-2" style="color: var(--primary);">200+</div>
                        <div class="text-sm font-semibold text-slate-500 uppercase tracking-wider">{content.stats.channels}</div>
                    </div>
                </div>

                <!-- Skills Section -->
                <section class="mb-24 skills-section scroll-animate">
                    <h2 class="text-3xl font-bold mb-8 flex items-center gap-4" style="color: var(--text);">
                        <span class="w-2 h-8 rounded-sm" style="background-color: var(--primary);"></span>
                        {content.sectionTitles.skills}
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                        {content.skills.map(group => (
                            <div class="space-y-4">
                                <h3 class="text-lg font-bold border-b-2 border-slate-100 pb-2" style="color: var(--primary);">
                                    {group.category}
                                </h3>
                                <ul class="space-y-2">
                                    {group.items.map(skill => (
                                        <li class="flex items-start gap-3 text-slate-600 text-base font-medium leading-snug">
                                            <span class="mt-[6px] text-[8px]" style="color: var(--primary);">●</span>
                                            <span>{skill}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ))}
                    </div>
                </section>
            </div>

            <!-- Experience Section -->
            <section class="mb-16 experience-container">
                <h2 class="text-3xl font-bold mb-10 flex items-center gap-4" style="color: var(--text);">
                    <span class="w-2 h-8 rounded-sm" style="background-color: var(--primary);"></span>
                    {content.sectionTitles.experience}
                </h2>
                
                <div class="space-y-12 border-l-[3px] border-slate-200 ml-3 md:ml-0 pl-8 md:pl-10">
                    {content.experiences.map((job, index) => (
                        <div class={`relative group job-item ${(index + 1) % 2 === 0 ? 'print:break-after-page' : ''}`}>
                            <div class="timeline-dot absolute -left-[43px] md:-left-[51px] top-2.5 w-5 h-5 rounded-full bg-white border-4 group-hover:scale-125 transition-transform duration-300 shadow-sm" style="border-color: var(--primary);"></div>
                            
                            <div class="space-y-3">
                                <div class="flex flex-col md:flex-row md:items-baseline md:justify-between gap-1">
                                    <h3 class="text-2xl font-bold transition-colors group-hover:text-[var(--primary)]" style="color: var(--text);">
                                        {job.title}
                                    </h3>
                                    <span class="text-slate-500 text-base font-semibold bg-slate-100 px-3 py-1 rounded-full inline-block w-fit whitespace-nowrap">
                                        {job.period}
                                    </span>
                                </div>
                                
                                <div class="text-xl font-semibold" style="color: var(--primary);">{job.company}</div>
                                
                                <ul class="space-y-3 text-slate-600 leading-relaxed text-lg mt-4">
                                    {job.highlights.map(highlight => (
                                        <li class="flex items-start gap-3">
                                            <svg class="w-5 h-5 shrink-0 mt-1" style="color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span>{highlight}</span>
                                        </li>
                                    ))}
                                </ul>

                                <div class="pt-4 flex flex-wrap gap-2">
                                    {job.tech.map(t => (
                                        <span class="skill-badge text-sm font-semibold px-3 py-1.5 rounded-md bg-slate-100 text-slate-600 border border-slate-200 transition-colors group-hover:border-[var(--primary)]">
                                            {t}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </section>

            <!-- Contact Info (Print Only) -->
            <section class="print-only mt-8 pt-8 pb-12 border-t-2 border-slate-200 break-before-this">
                <h2 class="text-2xl font-bold mb-6 text-center" style="color: var(--text);">{content.sectionTitles.contact}</h2>
                <div id="print-contact-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-6 text-base">
                    <!-- Row 1: Address & Phone -->
                    <div class="p-4 border border-slate-200 rounded bg-slate-50">
                        <p class="font-bold mb-1">{content.contactInfo.address}</p>
                        <p>{lang === 'vi' ? config.privateInfo.address.vi : config.privateInfo.address.en}</p>
                    </div>
                    <div class="p-4 border border-slate-200 rounded bg-slate-50">
                        <p class="font-bold mb-1">{content.contactInfo.phone}</p>
                        <p>{config.privateInfo.phone}</p>
                    </div>
                    <!-- Row 2: Email & LinkedIn -->
                    <div class="p-4 border border-slate-200 rounded bg-slate-50">
                        <p class="font-bold mb-1">{content.contactInfo.email}</p>
                        <a href={`mailto:${config.privateInfo.email}`} class="text-blue-600 underline">
                            {config.privateInfo.email}
                        </a>
                    </div>
                    <div class="p-4 border border-slate-200 rounded bg-slate-50">
                        <p class="font-bold mb-1">{content.contactInfo.linkedin}</p>
                        <a href={config.privateInfo.linkedin} target="_blank" class="text-blue-600 underline">
                            {config.privateInfo.linkedin.replace('https://', '').replace('www.', '')}
                        </a>
                    </div>
                </div>
            </section>
            
            <!-- Contact/Action Buttons (Web Only) -->
            <section class="mt-24 py-12 border-t-2 border-slate-200 text-center no-print scroll-animate">
                <h2 class="text-2xl font-bold mb-4" style="color: var(--text);">{content.contact.title}</h2>
                <p class="text-slate-600 mb-10 max-w-xl mx-auto">{content.contact.subtitle}</p>
                
                <div class="flex flex-col sm:flex-row items-center justify-center gap-5">
                    {/* Primary Button (Email) */}
                    <a 
                        href={`mailto:${config.privateInfo.email}`}
                        class="w-full sm:w-auto rounded-xl bg-white text-slate-700 font-bold border border-slate-300 shadow-sm group transition-all hover:scale-110 duration-200 flex items-center justify-center gap-2.5 hover:bg-slate-50"
                        style={`
                            margin-top: ${content.contact.primaryBtn.spacing.mt};
                            margin-right: ${content.contact.primaryBtn.spacing.mr};
                            margin-bottom: ${content.contact.primaryBtn.spacing.mb};
                            margin-left: ${content.contact.primaryBtn.spacing.ml};
                            padding-top: ${content.contact.primaryBtn.spacing.pt};
                            padding-right: ${content.contact.primaryBtn.spacing.pr};
                            padding-bottom: ${content.contact.primaryBtn.spacing.pb};
                            padding-left: ${content.contact.primaryBtn.spacing.pl};
                            --btn-hover: ${content.contact.primaryBtn.hoverColor};
                        `}
                    >
                        <span class="group-hover:text-[var(--btn-hover)] transition-colors flex items-center gap-2">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                             {content.contact.primaryBtn.label}
                        </span>
                    </a>
                    
                    {/* Download Button (Central) */}
                    <a 
                        href={`/${pdfFileName}`}
                        download={pdfFileName}
                        class="w-full sm:w-auto px-10 py-4 rounded-xl text-white font-bold hover:shadow-lg transition-all hover:scale-110 duration-200 flex items-center justify-center gap-2.5 shadow-md"
                        style="background-color: var(--primary);"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        {content.hero.download}
                    </a>

                    {/* Secondary Button (LinkedIn/Social) */}
                    <a 
                        href={config.privateInfo.linkedin}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="w-full sm:w-auto rounded-xl bg-white text-slate-700 font-semibold border border-slate-300 shadow-sm group transition-all hover:scale-110 duration-200 flex items-center justify-center gap-2.5 hover:bg-slate-50"
                        style={`
                            margin-top: ${content.contact.secondaryBtn.spacing.mt};
                            margin-right: ${content.contact.secondaryBtn.spacing.mr};
                            margin-bottom: ${content.contact.secondaryBtn.spacing.mb};
                            margin-left: ${content.contact.secondaryBtn.spacing.ml};
                            padding-top: ${content.contact.secondaryBtn.spacing.pt};
                            padding-right: ${content.contact.secondaryBtn.spacing.pr};
                            padding-bottom: ${content.contact.secondaryBtn.spacing.pb};
                            padding-left: ${content.contact.secondaryBtn.spacing.pl};
                            --btn-hover: ${content.contact.secondaryBtn.hoverColor};
                        `}
                    >
                         <span class="group-hover:text-[var(--btn-hover)] transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                            {content.contact.secondaryBtn.label}
                        </span>
                    </a>
                </div>
            </section>
            <Footer />
        </main>
        <Analytics />
        <script>
            import { navigate } from 'astro:transitions/client';

            document.addEventListener('astro:page-load', () => {
                // Animation Observer
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.1
                });
        
                const elementsToAnimate = document.querySelectorAll('.scroll-animate');
                elementsToAnimate.forEach(el => observer.observe(el));

                // Back to Top Logic
                const backToTopBtn = document.getElementById('back-to-top');
                if (backToTopBtn) {
                    const toggleBackToTop = () => {
                        if (window.scrollY > 300) {
                            backToTopBtn.classList.remove('opacity-0', 'invisible', 'translate-y-4');
                        } else {
                            backToTopBtn.classList.add('opacity-0', 'invisible', 'translate-y-4');
                        }
                    };

                    window.addEventListener('scroll', toggleBackToTop);
                    backToTopBtn.addEventListener('click', () => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                }

                // Language Switcher - Scroll Preservation Logic
                const langBtns = document.querySelectorAll('.lang-btn');
                langBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const href = btn.getAttribute('href');
                        if (href) {
                            const currentScroll = window.scrollY;
                            sessionStorage.setItem('scrollPosition', currentScroll.toString());
                            navigate(href, { history: 'replace' });
                        }
                    });
                });
            });

            // Restore scroll position after navigation
            document.addEventListener('astro:after-swap', () => {
                const savedScroll = sessionStorage.getItem('scrollPosition');
                if (savedScroll) {
                    window.scrollTo(0, parseInt(savedScroll));
                    sessionStorage.removeItem('scrollPosition');
                }
            });
        </script>
	</body>
</html>
